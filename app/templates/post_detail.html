<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Post Details</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/5.3.2/lux/bootstrap.min.css">
    <script>
      function formatLocalTime() {
        document.querySelectorAll('.localtime').forEach(function(el) {
          var utc = el.getAttribute('data-utc');
          if (utc) {
            var date = new Date(utc + 'Z');
            el.textContent = date.toLocaleString();
          }
        });
      }
      window.addEventListener('DOMContentLoaded', formatLocalTime);
    </script>
</head>
<body>
<div class="container mt-4">
    <nav class="mb-3">
        <a href="{{ url_for('index') }}" class="btn btn-outline-primary">Home</a>
        <span class="ms-3">Logged in as <strong>{{ username }}</strong></span>
        <a href="{{ url_for('logout') }}" class="btn btn-outline-danger ms-3">Logout</a>
    </nav>
    <h2 class="text-primary">Post by <span class="username">{{ post.username }}</span></h2>
    <div class="card mb-3">
        <div class="card-body">
            <p class="card-text">{{ post.content }}</p>
            <small class="text-muted">Last updated: <span class="localtime" data-utc="{{ (post.last_updated or post.created_at).strftime('%Y-%m-%dT%H:%M:%S') }}"></span></small>
            <br>
            <span class="badge bg-warning">{{ post.likes|length }} Likes</span>
            <span class="badge bg-secondary">{{ post.comments|length }} Comments</span>
        </div>
    </div>
    <form method="post" action="{{ url_for('like_post', post_id=post.id) }}" class="d-inline">
        <button type="submit" class="btn btn-warning">Like</button>
    </form>
    <form method="post" action="{{ url_for('unlike_post', post_id=post.id) }}" class="d-inline">
        <button type="submit" class="btn btn-outline-warning">Unlike</button>
    </form>
    {% if username == post.username %}
        <a href="{{ url_for('edit_post', post_id=post.id) }}" class="btn btn-info">Edit</a>
        <form method="post" action="{{ url_for('delete_post', post_id=post.id) }}" class="d-inline">
            <button type="submit" class="btn btn-danger">Delete</button>
        </form>
    {% endif %}
    <hr>
    <h4>Comments</h4>
    {% for comment in comments %}
    <div class="card mb-2">
        <div class="card-body">
            <span class="username">{{ comment.username }}</span>: {{ comment.content }}
            <small class="text-muted">Last updated: <span class="localtime" data-utc="{{ (comment.last_updated or comment.created_at).strftime('%Y-%m-%dT%H:%M:%S') }}"></span></small>
            <br>
            {% if username == comment.username %}
                <a href="{{ url_for('edit_comment', comment_id=comment.id) }}" class="btn btn-sm btn-outline-info">Edit</a>
                <form method="post" action="{{ url_for('delete_comment', comment_id=comment.id) }}" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                </form>
            {% endif %}
        </div>
    </div>
    {% else %}
    <p>No comments yet.</p>
    {% endfor %}
    <hr>
    <h5>Add a Comment</h5>
    <form method="post" action="{{ url_for('add_comment', post_id=post.id) }}">
        <!-- Username is shown at the top, not needed here -->
        <div class="mb-3">
            <textarea class="form-control" name="content" rows="2" placeholder="Your comment" required></textarea>
        </div>
        <button type="submit" class="btn btn-success">Comment</button>
    </form>
    <a href="{{ url_for('index') }}" class="btn btn-secondary mt-3">Back to Posts</a>
</div>
</body>
</html>
